<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{ scenario_name }} - {{ scene_dict["name"] }}</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.controls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.pathfinding.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/drbalar/aframe-super-keyboard@master/dist/aframe-super-keyboard.min.js"></script>
    <script src="https://unpkg.com/aframe-state-component@7.1.0/dist/aframe-state-component.min.js"></script>
    <script src="https://unpkg.com/aframe-drag-controls@1.0.0/index.js"></script>

    <!-- A-frame components   -->
    <!--  Keeping commented in case things go south for some reason -->
<!--    <script src="/static/js/components/animation-on-click.js"></script>-->
<!--    <script src="/static/js/components/close-popup.js"></script>-->
<!--    <script src="/static/js/components/keypad.js"></script>-->
<!--    <script src="/static/js/components/text-pane.js"></script>-->
<!--    <script src="/static/js/components/rotation-controls.js"></script>-->
<!--    <script src="/static/js/components/visual-pane.js"></script>-->
<!--    <script src="/static/js/libraries/TransformControls.js"></script>-->
<!--    <script src="/static/js/components/hint-button.js"></script>-->
<!--    <script src="/static/js/components/ordered-puzzle.js"></script>-->
<!--    <script src="/static/js/components/target-box.js"></script>-->
<!--    <script src="/static/js/components/jigsaw-puzzle.js"></script>-->
<!--    <script src="/static/js/components/interactable.js"></script>-->
<!--    <script src="/static/js/components/button-design.js"></script>-->

      <script src="/static/js/components.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NCV4M5LZE1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NCV4M5LZE1');
    </script>
    <style>
      .a-canvas.a-grab-cursor.a-mouse-cursor-hover{
        cursor:crosshair !important;
      }
    </style>
    <!-- Initial state  -->
    {% include state.html %}
  </head>

  <body>
    <div id="scene-root">
      <!-- Need to add  inspector="url: http://localhost:3333/dist/aframe-inspector.js" to the a-scene element if using local inspector -->
      <a-scene id="{{ scene_dict['id'] }}-scene" cursor="rayOrigin:mouse" raycaster="objects: .link"
        {% if is_admin %}
          inspector="url: {{ inspector_url }}"
        {% end %}
      >
        <a-assets timeout="50000">
          {% for object in scene_dict["objects"] %}
          <!--  TODO: deal with multiple objects of same asset type  -->
          <a-asset-item
            id="{{ object['asset_id'] }}-asset-src"
            src="{{ asset_prefix_url }}{{ object['asset_details']['s3_key'] }}"
          ></a-asset-item>
          {% end %}

        <!--  Background  -->
          <a-asset-item
            id="{{ scene_dict['background_details']['id'] }}-asset-src"
            src="{{ asset_prefix_url }}{{ scene_dict['background_details']['s3_key'] }}"
          ></a-asset-item>

        <!--  Background nav mesh  -->
          <a-asset-item
            id="{{ scene_dict['background_details']['id'] }}-asset-navmesh-src"
            src="{{ asset_prefix_url }}{{ navmesh_src }}"
          ></a-asset-item>

        </a-assets>
        <a-entity environment="preset: forest; dressingAmount: 500; playArea: 10"></a-entity>

        <!--  Background  -->
        <a-gltf-model
            id="{{ scene_dict['background_details']['id'] }}-background"
            class="link"
            src="#{{ scene_dict['background_details']['id'] }}-asset-src"
            position="{{ scene_dict['position'][0] }} {{ scene_dict['position'][1] }} {{ scene_dict['position'][2] }}"
            scale="{{ scene_dict['scale'][0] }} {{ scene_dict['scale'][1] }} {{ scene_dict['scale'][2] }}"
            rotation="{{ scene_dict['rotation'][0] }} {{ scene_dict['rotation'][1] }} {{ scene_dict['rotation'][2] }}"
        ></a-gltf-model>

        <!--  Background nav-mesh     -->
        <a-gltf-model
            id="{{ scene_dict['background_details']['id'] }}-background-navmesh"
            src="#{{ scene_dict['background_details']['id'] }}-asset-navmesh-src"
            position="{{ scene_dict['position'][0] }} {{ scene_dict['position'][1] }} {{ scene_dict['position'][2] }}"
            scale="{{ scene_dict['scale'][0] }} {{ scene_dict['scale'][1] }} {{ scene_dict['scale'][2] }}"
            rotation="{{ scene_dict['rotation'][0] }} {{ scene_dict['rotation'][1] }} {{ scene_dict['rotation'][2] }}"
            nav-mesh
            visible="false"
        ></a-gltf-model>

        <a-entity id="rig"
                movement-controls="constrainToNavMesh: true;
                                   controls: checkpoint, gamepad, trackpad, keyboard, touch;"
                position="{{ scene_dict['camera_properties']['position'][0] }} 0.67 {{ scene_dict['camera_properties']['position'][2] }}">
        <a-entity
          id="primaryCamera"
          {% if cur_scene_idx == 0 %}
            camera="active: false;"
          {% else %}
            camera="active: true;"
          {% end %}
          fov="80"
          {% if scene_dict["camera_properties"]["look_controls"] %}
            look-controls="reverseMouseDrag: true"
          {% end %}
          position="0 {{ scene_dict['camera_properties']['position'][1] }} 0"
        >

        {% if not is_admin %}
        <!--   Hints    -->
        <a-entity
          id="hint-button"
          class="link"
          hint-button='jsonData: {"newHintImg": "/static/img/lightOn.png", "hintImg": "/static/img/lightOff.png", "width": 0.15, "height": 0.04}'
          animation__onclick="property: position; dur: 0; startEvents: click"
          animation-on-click-run='blackboardData: {"jsonData": {"data": {{ json_encode( [ {"text": x} for x in scene_dict["hints"] ] ) }}, "currPosition": 0}, "componentType": "text-pane"}'
        >
        </a-entity>
      {% end %}
        </a-entity>
      </a-entity>
        {% include popup.html %}


        <!-- Objects in the scene -->
        {% for object in scene_dict["objects"] %}
        <a-gltf-model
          id="{{ object['id'] }}-obj"
          src="#{{ object['asset_id'] }}-asset-src"
          position="{{ object['position'][0] }} {{ object['position'][1] }} {{ object['position'][2] }}"
          scale="{{ object['scale'][0] }} {{ object['scale'][1] }} {{ object['scale'][2] }}"
          rotation="{{ object['rotation'][0] }} {{ object['rotation'][1] }} {{ object['rotation'][2] }}"
          {% if object["is_interactable"] %}
            class="link"
            animation__onclick="property: position; dur: 0; startEvents: click"
            animation-on-click-run='blackboardData: {{ json_encode(object["animations_json"]["blackboardData"]) }}'
            interactable
          {% end %}
        ></a-gltf-model>
        {% end %}
      </a-scene>
      <script>
        const scene = document.querySelector('a-scene');
        // Transition logic only needed for non-admins
        {% if not is_admin %}
          <!--  Logic for scene completion  -->
          const is_last_scene = {{ is_last_scene }};
          const next_scene_idx = {{ cur_scene_idx }} + 1;

          if({{cur_scene_idx }} == 0){
            const intro_transition_data = {% raw json_encode(scenario_transitions[0]) %};
            intro_transition_data["isTransition"] = false;
            addTransition(intro_transition_data);
          }

          scene.addEventListener("dcc-success-scene-complete", function () {
            let nextURL = ""
            let transitionData = {};
            if (is_last_scene) {
              // it is last scene, navigate to same scene for now
              transitionData = {% raw json_encode(scenario_transitions[-1]) %};
              nextURL = "/{{ scenario_friendly_name }}/completed";
            } else {
              {% if is_last_scene != "true" %}
                transitionData = {% raw json_encode(scenario_transitions[cur_scene_idx + 1]) %};
              {% end %}
              nextURL = "/{{ scenario_friendly_name }}/" + next_scene_idx;
            }

            transitionData["transitionURL"] = nextURL;
            transitionData["isTransition"] = true;

            addTransition(transitionData);
          });
        {% end %}

        function addTransition(transition_data) {
          let componentDataParsed = {
            "componentType": "text-pane",
            "jsonData": transition_data
          };
          addEntityToBlackboard(componentDataParsed);
        }

    async function sceneComplete(numSeconds, nextURL) {
      setTimeout(function () {
         window.location.replace(nextURL);
      }, numSeconds * 1000);
    }

    {% if is_admin %}
      const inspector = scene.components.inspector;
      const backgroundEl = document.getElementById("{{ scene_dict['background_details']['id'] }}-background");
      let initial_load_js = false;
      {% if take_screenshot %}
          initial_load_js = true;
      {% end %}

      scene.addEventListener('loaded', function () {
          {% if take_screenshot %}
          backgroundEl.addEventListener('model-loaded', function () {
             takeSceneScreenshot();
          });
          {% end %}
          inspector.openInspector();
      });
      async function takeSceneScreenshot(s3_key=""){
        if(initial_load_js || s3_key !== ""){
            const screenshot_canvas = scene.components.screenshot.getCanvas('perspective');
            await uploadScreenshotToS3(screenshot_canvas.toDataURL("image/jpeg"), s3_key);
          }
      }
      async function uploadScreenshotToS3(canvasDataUrl, s3_key){
         const blobData = dataURItoBlob(canvasDataUrl);
         await sendPresignedData(blobData, s3_key);
      }
      async function sendPresignedData(blobData, s3_key){
          const xhr = new XMLHttpRequest();
          xhr.responseType = "json";
          xhr.open("POST", "/api/admin/v1/upload");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.setRequestHeader("X-Xsrftoken", getCookieScene("_xsrf"));
          const requestData = {
              type: "image",
              extension: "jpeg",
              s3_key: s3_key
          }
          xhr.onload  = function() {
              const jsonResponse = xhr.response;
              const formData = new FormData();
              Object.keys(jsonResponse.fields).forEach(key => {
                    formData.append(key, jsonResponse.fields[key]);
              });
              formData.append("file", blobData);
              const xhr_s3 = new XMLHttpRequest();
              xhr_s3.withCredentials = false;
              xhr_s3.open("POST", jsonResponse.url);
              xhr_s3.setRequestHeader('Access-Control-Allow-Headers', '*');
              xhr_s3.setRequestHeader('Access-Control-Allow-Origin', '*');
              xhr_s3.onload = function() {
                  if(xhr_s3.status === 200 || xhr_s3.status === 204){
                      const xhr_update_scene = new XMLHttpRequest();
                      xhr_update_scene.responseType = "json";
                      xhr_update_scene.open("PUT", "/api/admin/v1/scene/" + {{ scene_dict['id'] }} + "/screenshot");
                      xhr_update_scene.setRequestHeader("Content-Type", "application/json");
                      xhr_update_scene.setRequestHeader("X-Xsrftoken", getCookieScene("_xsrf"));
                      const requestData_update = {
                          screenshot_url: jsonResponse.s3_key
                      }
                      xhr_update_scene.send(JSON.stringify(requestData_update));
                      initial_load_js = false;
                  }
                  {# else request failed, not much we can do at this point, no point displaying this to admins #}
                  {# it will just try again on next load since scene's screenshot URL will still be empty #}
              }
              xhr_s3.send(formData);
          };
          xhr.send(JSON.stringify(requestData));
      }
      function getCookieScene(name) {
          let r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
          return r ? r[1] : undefined;
      }
      function dataURItoBlob(dataURI) {
          const binary = atob(dataURI.split(',')[1]);
          const array = [];
          for(let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
      }

    {% end %}
  </script>
  </body>
</html>
