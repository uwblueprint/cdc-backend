<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{ scenario_name }} - Tutorial</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.controls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.pathfinding.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-super-keyboard@2.1.0/dist/aframe-super-keyboard.min.js"></script>
    <script src="https://unpkg.com/aframe-state-component@7.1.0/dist/aframe-state-component.min.js"></script>
    <script src="https://unpkg.com/aframe-drag-controls@1.0.0/index.js"></script>
    <!-- A-frame components -->
    <!-- TODO: minify and combine all components once we are done -->
    <script src="/static/js/components/animation-on-click.js"></script>
    <script src="/static/js/components/close-popup.js"></script>
    <script src="/static/js/components/keypad.js"></script>
    <script src="/static/js/components/text-pane.js"></script>
    <script src="/static/js/components/visual-pane.js"></script>
    <script src="/static/js/components/hint-button.js"></script>
    <script src="/static/js/components/button-design.js"></script>
    <script src="/static/js/components/tutorial-instructions.js"></script>
    <!-- Initial state -->
    <script>
      AFRAME.registerState({
        initialState: {
          solvedObjects: {},
        },
        handlers: {
          solvedObject: function (state, action) {
            state.solvedObjects[action.id] = true;
          },
          initializeObject: function (state, action) {
            state.solvedObjects[action.id] = action.solved;
          },
        },
      });
    </script>
  </head>
  <body>
    <div id="scene-root">
      <a-scene id="3-scene" cursor="rayOrigin:mouse" raycaster="objects: .link">
        <a-assets timeout="50000">
          <a-asset-item
            id="1-asset-src"
            src="{{ asset_prefix_url }}assets/752258ee7ff140e98a6f73fcca4e7efd.glb"
          ></a-asset-item>
          <a-asset-item
            id="3-asset-src"
            src="{{ asset_prefix_url }}assets/ad75dbcdd75e419ba23c44a8cc54b3a1.glb"
          ></a-asset-item>
          <!-- Background -->
          <a-asset-item
            id="2-asset-src"
            src="{{ asset_prefix_url }}assets/25c4ff61b3144b749308adf00bcc637a.glb"
          ></a-asset-item>
          <!-- Background nav mesh -->
          <a-asset-item
            id="2-asset-navmesh-src"
            src="{{ asset_prefix_url }}assets/25c4ff61b3144b749308adf00bcc637a-navmesh.gltf"
          ></a-asset-item>
        </a-assets>
        <a-entity
          environment="preset: forest; dressingAmount: 500; playArea: 10"
        ></a-entity>
        <!-- Background -->
        <a-gltf-model
          id="2-background"
          src="#2-asset-src"
          position="0.0 0.03 0.0"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <!-- Background nav-mesh -->
        <a-gltf-model
          id="2-background-navmesh"
          src="#2-asset-navmesh-src"
          position="0.0 0.03 0.0"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
          nav-mesh
          visible="false"
        ></a-gltf-model>
        <a-entity
          id="rig"
          movement-controls="constrainToNavMesh: true;
controls: checkpoint, gamepad, trackpad, keyboard, touch;"
          position="-2.17 0 2.659"
        >
          <a-entity
            id="primaryCamera"
            camera="active: false;"
            fov="80"
            look-controls="reverseMouseDrag: true"
            position="0 1.689 0"
          >
            <a-entity
              id="tutorial-instructions"
              tutorial-instructions
            ></a-entity>

            <!-- Hints -->
            <a-entity
              id="hint-button"
              class="link"
              visible="false"
              hint-button='jsonData: {"newHintImg": "/static/img/lightOn.png", "hintImg": "/static/img/lightOff.png", "width": 0.15, "height": 0.04}'
              animation__onclick="property: position; dur: 0; startEvents: click"
              animation-on-click-run='blackboardData: {"jsonData": {"data": [{"text": "The password is 1591. Enter it on the keypad to escape!"}], "currPosition": 0}, "componentType": "text-pane"}'
            >
            </a-entity>
          </a-entity>
        </a-entity>
        <a-entity id="readRoom" position="0 -500 0">
          <a-entity
            id="blackboard"
            visible="true"
            geometry="primitive: plane; width: 18 ; height: 15"
            material="color: #242424; shader: flat; transparent: false"
          >
          </a-entity>
          <a-entity
            id="returnButton"
            close-popup='jsonData: {"width": "1", "height": "1", "depth": "0.01", "color": "red", "opacity": "0", "x": "-8.25", "y": "6.75", "z": "0.005"};'
            visible="false"
            tutorial-hints
            button-design
          >
            <a-text
              id="xClose"
              align="center"
              font="https://raw.githubusercontent.com/jaydhulia/aframe-fonts/master/fonts/poppins/Poppins-Bold.json"
              wrapCount="1"
              value="X"
              shader="msdf"
              scale="2 2 1"
              position="0 -0.4 0"
            ></a-text>
          </a-entity>

          <a-entity
            id="blackboardText"
            text="align: center; width: 15; font: https://raw.githubusercontent.com/jaydhulia/aframe-fonts/master/fonts/poppins/Poppins-Bold.json; shader: msdf"
            position="0 5 0.005"
          ></a-entity>
          <a-entity
            id="blackboardParagraph"
            text="align: center; width: 15; wrapCount: 60"
            position="0 -6 0.005"
          ></a-entity>
          <a-entity
            id="popup-camera"
            position="0 0 9"
            rotation="0 0 0"
            camera="active: true;"
          ></a-entity>
        </a-entity>

        <!-- Objects in the scene -->

        <a-gltf-model
          id="3-obj"
          src="#1-asset-src"
          position="1.450 0.014 -0.925"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <a-gltf-model
          id="4-obj"
          src="#1-asset-src"
          position="-1.450 0.014 -0.925"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <a-gltf-model
          id="5-obj"
          src="#1-asset-src"
          position="1.450 0.014 -2.725"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <a-gltf-model
          id="6-obj"
          src="#1-asset-src"
          position="-1.450 0.014 -2.725"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <a-gltf-model
          id="7-obj"
          src="#1-asset-src"
          position="1.450 0.014 0.875"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>
        <a-gltf-model
          id="8-obj"
          src="#1-asset-src"
          position="-1.450 0.014 0.875"
          scale="1.0 1.0 1.0"
          rotation="0.0 0.0 0.0"
        ></a-gltf-model>

        <a-gltf-model
          id="9-obj"
          src="#3-asset-src"
          position="3.667 0.827 4.083"
          scale="0.15 0.15 0.15"
          rotation="0.0 0.0 0.0"
          animation__mouseenter="property: scale; to: 0.19 0.19 0.19; dur: 100; startEvents: mouseenter"
          animation__mouseleave="property: scale; to: 0.15 0.15 0.15 dur: 100; startEvents: mouseleave"
          {#
          animation__onclick="property: position; dur: 0; startEvents: click"
          #}
          animation__onclick_tutorial="property: position; dur: 0; startEvents: click"
          animation-on-click-run='blackboardData: {"jsonData": {"model": "numpad", "password": "1591", "is_last_object": true}, "componentType": "keypad", "blackboardText": "Looks like you don&apos;t know the password yet!", "blackboardParagraph": "Click on the \"X\" to exit the pin pad." }'
          visible="false"
        ></a-gltf-model>
      </a-scene>
      <script>
        const scene = document.querySelector("a-scene");
        // Transition logic only needed for non-admins

        <!-- Logic for scene completion -->
        const intro_transition_data = {
          data: [
            {
              text:
                "Hey there, welcome to the tutorial! To move around, you can use the WASD keys on your keyboard. Try it out, I'll guide you!",
            },
          ],
          currPosition: 0,
          isTransition: false,
        };
        addTransition(intro_transition_data);
        scene.addEventListener("dcc-success-scene-complete", function () {
          let transitionData = {
            data: [
              {
                text:
                  "Congratulations on finishing the tutorial! Good luck with the rest of the escape room. The next few rooms will not be this easy.",
              },
            ],
            currPosition: 0,
          };

          transitionData["transitionURL"] =
            "/{{ scenario_friendly_name }}/" + 0;
          transitionData["isTransition"] = true;
          addTransition(transitionData);
        });

        function addTransition(transition_data) {
          let componentDataParsed = {
            componentType: "text-pane",
            jsonData: transition_data,
          };
          addEntityToBlackboard(componentDataParsed);
        }
        async function sceneComplete(numSeconds, nextURL) {
          setTimeout(function () {
            window.location.replace(nextURL);
          }, numSeconds * 1000);
        }
      </script>
    </div>
  </body>
</html>
